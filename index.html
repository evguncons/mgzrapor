import React, { useState, useMemo } from 'react';
import { 
  Search, Plus, TrendingUp, Star, MessageSquare, Trash2, 
  ExternalLink, X, BarChart2, RefreshCw, MapPin, Download,
  ArrowUpRight, Award, PieChart, Activity
} from 'lucide-react';

const App = () => {
  // Sağlanan Google Cloud API Key
  const apiKey = "AIzaSyAjePuGhXs2Yo40V7wQGZ8hzH35neIneR0"; 

  // Mağaza listesi - Place ID'ler ve Linkler güncel
  const [stores, setStores] = useState([
    { id: 1, name: 'Paşabahçe', oldReviews: 101, oldRating: 3.5, currentReviews: 101, currentRating: 3.5, placeId: 'ChIJV8DIsAPLyhQRV9vFqMEc7tM', url: 'https://business.google.com/n/7997354022054718135/profile?fid=15271175004545735511' },
    { id: 2, name: 'Kavacık', oldReviews: 254, oldRating: 3.4, currentReviews: 271, currentRating: 3.5, placeId: 'ChIJ47j-hjXKyhQRKrygMRHvVpQ', url: 'https://business.google.com/n/8309192799194203621/profile?fid=10688993622736550954' },
    { id: 3, name: 'Çekmeköy', oldReviews: 205, oldRating: 3.4, currentReviews: 225, currentRating: 3.5, placeId: 'ChIJmX-qCVrOyhQRM6PvK-x_9w8', url: 'https://business.google.com/n/5387270539767312637/profile?fid=1150528882142585651' },
    { id: 4, name: 'Yenidoğan', oldReviews: 332, oldRating: 3.4, currentReviews: 334, currentRating: 3.4, placeId: 'ChIJ8wW6b9vRyhQRE68ZJNcLjNU', url: 'https://business.google.com/n/9187331619992065040/profile?fid=15387687045469679379' },
    { id: 5, name: 'Sultanbeyli', oldReviews: 87, oldRating: 3.0, currentReviews: 99, currentRating: 3.3, placeId: 'ChIJOYNnZ2nQyhQRVpW3Q04PD2c', url: 'https://business.google.com/n/3657792668448834138/profile?fid=7426171139375207766' },
    { id: 6, name: 'Çayırova', oldReviews: 1, oldRating: 5.0, currentReviews: 8, currentRating: 5.0, placeId: 'ChIJ_2olSt_fyhQRj0aWv2XjDFc', url: 'https://business.google.com/n/10220491491830758537/profile?fid=6272638407165757071' },
    { id: 7, name: 'Körfez', oldReviews: 216, oldRating: 3.3, currentReviews: 216, currentRating: 3.3, placeId: 'ChIJRfbZV4I4yxQRv5OcNUlTv88', url: 'https://business.google.com/n/8841866398671752798/profile?fid=14969775260299989951' },
    { id: 8, name: 'Derince', oldReviews: 84, oldRating: 3.4, currentReviews: 91, currentRating: 3.5, placeId: 'ChIJ5T1DP55HyxQR9H7LAE4LTGE', url: 'https://business.google.com/n/7909159651546170846/profile?fid=7010991149557710580' },
    { id: 9, name: 'İzmit', oldReviews: 99, oldRating: 3.3, currentReviews: 100, currentRating: 3.3, placeId: 'ChIJl6QMEeJPyxQRsRA_Bvck76c', url: 'https://business.google.com/n/3483797429369724523/profile?fid=12100931367148130481' },
    { id: 10, name: 'Gölcük', oldReviews: 116, oldRating: 3.4, currentReviews: 128, currentRating: 3.6, placeId: 'ChIJvezYrBVByxQRaEKbx9ci_JM', url: 'https://business.google.com/n/4940591458180238810/profile?fid=10663436327868645992' },
    { id: 11, name: 'İnegöl', oldReviews: 10, oldRating: 3.3, currentReviews: 30, currentRating: 4.4, placeId: 'ChIJa8X3P73JyxQRc03K6nM70BM', url: 'https://business.google.com/n/4940591458180238810/profile?fid=10663436327868645992' },
    { id: 12, name: 'Gebze', oldReviews: 0, oldRating: 0, currentReviews: 0, currentRating: 0, placeId: 'ChIJF9oL8eMhyxQRAQmtPs7mK0I', url: 'https://business.google.com/n/3759899973095957400/profile?fid=4768158403990980865' },
  ]);

  const [loading, setLoading] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [isAdding, setIsAdding] = useState(false);
  const [newStore, setNewStore] = useState({ name: '', placeId: '', reviews: '', rating: '' });

  // Kısa Analiz Özeti Hesaplamaları
  const analytics = useMemo(() => {
    const totalNewReviews = stores.reduce((acc, s) => acc + (s.currentReviews - s.oldReviews), 0);
    const avgRating = stores.length > 0 ? (stores.reduce((acc, s) => acc + s.currentRating, 0) / stores.length).toFixed(1) : 0;
    
    let bestImprover = stores[0];
    stores.forEach(s => {
      const currentImprovement = s.currentRating - s.oldRating;
      const bestImprovement = bestImprover.currentRating - bestImprover.oldRating;
      if (currentImprovement > bestImprovement) bestImprover = s;
    });

    return { totalNewReviews, avgRating, bestImprover };
  }, [stores]);

  // PDF / Yazdır Fonksiyonu
  const handleExportPDF = () => {
    window.print();
  };

  const syncData = async () => {
    setLoading(true);
    try {
      const updatedStores = await Promise.all(stores.map(async (store) => {
        if (!store.placeId) return store;
        const url = `https://maps.googleapis.com/maps/api/place/details/json?place_id=${store.placeId}&fields=rating,user_ratings_total&key=${apiKey}&language=tr`;
        const res = await fetch(url);
        const data = await res.json();
        if (data.status === "OK" && data.result) {
          return {
            ...store,
            currentReviews: data.result.user_ratings_total || store.currentReviews,
            currentRating: data.result.rating || store.currentRating
          };
        }
        return store;
      }));
      setStores(updatedStores);
    } catch (err) {
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const filteredStores = stores.filter(s => s.name.toLowerCase().includes(searchTerm.toLowerCase()));

  return (
    <div className="min-h-screen bg-[#f8fafc] p-4 md:p-8 font-sans text-slate-900 print:bg-white print:p-0">
      <style>{`
        @media print {
          .no-print { display: none !important; }
          .print-only { display: block !important; }
          .shadow-sm, .shadow-lg { shadow: none !important; border: 1px solid #eee !important; }
          body { background: white !important; }
          .page-break { page-break-before: always; }
        }
      `}</style>

      <div className="max-w-7xl mx-auto">
        
        {/* Header & PDF Button */}
        <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-8 no-print">
          <div className="flex items-center gap-4">
            <div className="bg-[#1e293b] p-3.5 rounded-2xl text-white shadow-xl shadow-slate-200">
              <BarChart2 size={28} />
            </div>
            <div>
              <h1 className="text-3xl font-black text-slate-800 tracking-tight uppercase">Hedef AVM</h1>
              <div className="flex items-center gap-2 text-slate-500 text-sm font-medium">
                <div className={`w-2 h-2 rounded-full ${loading ? 'bg-amber-500 animate-pulse' : 'bg-green-500'}`}></div>
                Google İşletme Performans İzleyici
              </div>
            </div>
          </div>

          <div className="flex items-center gap-3 w-full md:w-auto">
            <button 
              onClick={handleExportPDF}
              className="flex-1 md:flex-none flex items-center justify-center gap-2 bg-white border-2 border-slate-200 text-slate-700 px-5 py-2.5 rounded-xl font-bold hover:bg-slate-50 hover:border-slate-300 transition-all shadow-sm"
            >
              <Download size={18} /> PDF Raporu Al
            </button>
            <button 
              onClick={syncData}
              disabled={loading}
              className="flex-1 md:flex-none flex items-center justify-center gap-2 bg-indigo-600 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100 disabled:opacity-50"
            >
              <RefreshCw size={18} className={loading ? 'animate-spin' : ''} />
              {loading ? 'Güncelleniyor...' : 'Verileri Yenile'}
            </button>
          </div>
        </header>

        {/* Analiz Özeti Paneli */}
        <section className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden">
            <div className="absolute top-0 right-0 p-4 opacity-10 text-indigo-600"><TrendingUp size={64} /></div>
            <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Toplam Yorum Artışı</p>
            <h3 className="text-3xl font-black text-slate-800">+{analytics.totalNewReviews}</h3>
            <p className="text-xs text-indigo-600 font-bold mt-2 flex items-center gap-1">
              <ArrowUpRight size={14} /> Son güncellemeden itibaren
            </p>
          </div>

          <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm relative overflow-hidden">
            <div className="absolute top-0 right-0 p-4 opacity-10 text-amber-500"><Star size={64} /></div>
            <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Genel Puan Ort.</p>
            <h3 className="text-3xl font-black text-slate-800">{analytics.avgRating} <span className="text-sm text-slate-400">/ 5.0</span></h3>
            <div className="flex gap-0.5 mt-2">
              {[1,2,3,4,5].map(i => <Star key={i} size={14} fill={i <= Math.round(analytics.avgRating) ? "#f59e0b" : "none"} className={i <= Math.round(analytics.avgRating) ? "text-amber-500" : "text-slate-200"} />)}
            </div>
          </div>

          <div className="bg-[#1e293b] p-6 rounded-2xl shadow-xl md:col-span-2 text-white relative overflow-hidden">
            <div className="absolute top-0 right-0 p-4 opacity-20 text-indigo-400"><Award size={80} /></div>
            <div className="relative z-10">
              <p className="text-xs font-bold text-indigo-300 uppercase tracking-wider mb-1">Ayın En Çok Gelişen Mağazası</p>
              <h3 className="text-2xl font-black mb-1">{analytics.bestImprover?.name}</h3>
              <p className="text-sm text-slate-300">
                Puanını <span className="text-green-400 font-bold">+{ (analytics.bestImprover?.currentRating - analytics.bestImprover?.oldRating).toFixed(1) }</span> artırarak 
                <span className="text-white font-bold"> {analytics.bestImprover?.currentRating}</span> seviyesine taşıdı.
              </p>
            </div>
          </div>
        </section>

        {/* Tablo Arama & Filtre (No Print) */}
        <div className="mb-6 flex flex-col md:flex-row gap-4 no-print">
          <div className="relative flex-1">
            <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={20} />
            <input 
              type="text" 
              placeholder="Mağaza adına göre filtrele..."
              className="w-full pl-12 pr-4 py-3 bg-white border-2 border-slate-100 rounded-2xl focus:border-indigo-500 focus:ring-0 transition-all outline-none font-medium text-slate-600"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
          </div>
          <button onClick={() => setIsAdding(true)} className="bg-slate-800 text-white px-6 py-3 rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-slate-900 transition-all">
            <Plus size={20} /> Yeni Mağaza
          </button>
        </div>

        {/* Ana Tablo */}
        <div className="bg-white rounded-3xl border border-slate-200 shadow-xl overflow-hidden mb-12">
          <div className="overflow-x-auto">
            <table className="w-full text-left border-collapse">
              <thead>
                <tr className="bg-slate-50 border-b border-slate-100">
                  <th className="px-8 py-5 text-xs font-black text-slate-400 uppercase tracking-widest">Mağaza Detayı</th>
                  <th className="px-6 py-5 text-xs font-black text-slate-400 uppercase tracking-widest text-center">Referans Veriler</th>
                  <th className="px-6 py-5 text-xs font-black text-indigo-600 uppercase tracking-widest text-center bg-indigo-50/30">Güncel Yorum</th>
                  <th className="px-6 py-5 text-xs font-black text-indigo-600 uppercase tracking-widest text-center bg-indigo-50/30">Güncel Puan</th>
                  <th className="px-8 py-5 text-xs font-black text-slate-400 uppercase tracking-widest text-right no-print">Aksiyon</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-50">
                {filteredStores.map((store) => {
                  const reviewDiff = store.currentReviews - store.oldReviews;
                  const ratingDiff = parseFloat((store.currentRating - store.oldRating).toFixed(1));
                  
                  return (
                    <tr key={store.id} className="hover:bg-slate-50/50 transition-colors group">
                      <td className="px-8 py-6">
                        <div className="flex flex-col">
                          <span className="font-bold text-slate-800 text-lg leading-tight">{store.name}</span>
                          <div className="flex items-center gap-1.5 mt-1.5 no-print">
                            <MapPin size={12} className="text-indigo-400" />
                            <span className="text-[10px] font-mono text-slate-400 uppercase tracking-tighter">{store.placeId || 'ID GİRİLMEMİŞ'}</span>
                          </div>
                        </div>
                      </td>
                      <td className="px-6 py-6 text-center">
                        <div className="inline-flex flex-col items-center bg-slate-100/50 px-3 py-1.5 rounded-xl border border-slate-100">
                          <span className="text-xs font-bold text-slate-500">{store.oldReviews} Yorum</span>
                          <span className="text-xs font-black text-slate-600">{store.oldRating.toFixed(1)} ★</span>
                        </div>
                      </td>
                      
                      <td className="px-6 py-6 text-center bg-indigo-50/10">
                        <div className="flex flex-col items-center">
                          <span className="text-2xl font-black text-slate-800">{store.currentReviews}</span>
                          <span className={`text-[11px] font-black px-2 py-0.5 rounded-lg mt-1 ${reviewDiff > 0 ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-400'}`}>
                            {reviewDiff >= 0 ? '+' : ''}{reviewDiff} ADET
                          </span>
                        </div>
                      </td>
                      
                      <td className={`px-6 py-6 text-center transition-colors ${ratingDiff > 0 ? 'bg-green-50/30' : 'bg-indigo-50/10'}`}>
                        <div className="flex flex-col items-center">
                          <div className="flex items-center gap-1.5">
                            <span className="text-2xl font-black text-slate-800">{store.currentRating.toFixed(1)}</span>
                            <Star size={16} fill="#f59e0b" className="text-amber-500 mb-1" />
                          </div>
                          <span className={`text-[11px] font-black px-2 py-0.5 rounded-lg mt-1 ${ratingDiff > 0 ? 'bg-green-600 text-white shadow-sm' : 'bg-slate-100 text-slate-400'}`}>
                            {ratingDiff >= 0 ? '+' : ''}{ratingDiff} PUAN
                          </span>
                        </div>
                      </td>
                      
                      <td className="px-8 py-6 text-right no-print">
                        <div className="flex justify-end gap-2">
                          <a 
                            href={store.url} target="_blank" rel="noopener noreferrer"
                            className="p-2.5 bg-white border border-slate-200 text-indigo-600 hover:bg-indigo-50 hover:border-indigo-200 rounded-xl transition-all shadow-sm"
                            title="Google Profili"
                          >
                            <ExternalLink size={18} />
                          </a>
                          <button 
                            onClick={() => setStores(stores.filter(s => s.id !== store.id))}
                            className="p-2.5 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all"
                          >
                            <Trash2 size={18} />
                          </button>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
          {filteredStores.length === 0 && (
            <div className="p-20 text-center flex flex-col items-center gap-4">
              <div className="p-4 bg-slate-50 rounded-full text-slate-300"><Search size={48} /></div>
              <p className="font-bold text-slate-400 tracking-tight">Eşleşen mağaza bulunamadı.</p>
            </div>
          )}
        </div>

        {/* Footer (Print Only) */}
        <footer className="hidden print-only mt-12 pt-8 border-t border-slate-200">
          <div className="flex justify-between items-end">
            <div>
              <p className="text-sm font-bold text-slate-800 uppercase tracking-widest">HEDEF AVM YÖNETİM RAPORU</p>
              <p className="text-xs text-slate-400 mt-1">Oluşturulma Tarihi: {new Date().toLocaleDateString('tr-TR')}</p>
            </div>
            <div className="text-right">
              <p className="text-xs text-slate-400">Bu rapor Google Places API verileri kullanılarak otomatik oluşturulmuştur.</p>
            </div>
          </div>
        </footer>

        {/* Add Modal */}
        {isAdding && (
          <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-md flex items-center justify-center z-[100] p-4 no-print">
            <div className="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-lg overflow-hidden animate-in fade-in zoom-in duration-300">
              <div className="p-8 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div className="flex items-center gap-3">
                  <div className="bg-indigo-600 p-2 rounded-lg text-white"><Plus size={20} /></div>
                  <h3 className="text-xl font-black text-slate-800">Yeni Mağaza Tanımla</h3>
                </div>
                <button onClick={() => setIsAdding(false)} className="p-2 hover:bg-slate-100 rounded-full transition-colors"><X size={24} className="text-slate-400" /></button>
              </div>
              <div className="p-8 space-y-6">
                <div>
                  <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Mağaza İsmi</label>
                  <input className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-3.5 focus:border-indigo-500 outline-none font-bold" value={newStore.name} onChange={(e) => setNewStore({...newStore, name: e.target.value})} />
                </div>
                <div>
                  <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Google Place ID</label>
                  <input className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-3.5 focus:border-indigo-500 outline-none font-mono text-sm" placeholder="ChIJ..." value={newStore.placeId} onChange={(e) => setNewStore({...newStore, placeId: e.target.value})} />
                </div>
                <div className="grid grid-cols-2 gap-6">
                  <div>
                    <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Referans Yorum</label>
                    <input type="number" className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-3.5" value={newStore.reviews} onChange={(e) => setNewStore({...newStore, reviews: e.target.value})} />
                  </div>
                  <div>
                    <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Referans Puan</label>
                    <input type="number" step="0.1" className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-3.5" value={newStore.rating} onChange={(e) => setNewStore({...newStore, rating: e.target.value})} />
                  </div>
                </div>
              </div>
              <div className="p-8 bg-slate-50 border-t border-slate-100 flex gap-4">
                <button onClick={() => setIsAdding(false)} className="flex-1 py-4 font-bold text-slate-400 hover:text-slate-600 transition-colors">Vazgeç</button>
                <button onClick={() => {
                  if(!newStore.name) return;
                  setStores([...stores, { ...newStore, id: Date.now(), oldReviews: parseInt(newStore.reviews)||0, oldRating: parseFloat(newStore.rating)||0, currentReviews: parseInt(newStore.reviews)||0, currentRating: parseFloat(newStore.rating)||0, url: '#' }]);
                  setIsAdding(false);
                  setNewStore({ name: '', placeId: '', reviews: '', rating: '' });
                }} className="flex-[2] bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition-all">Sisteme Ekle</button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default App;
