<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hedef AVM | Gelişmiş Yönetim Paneli</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (Excel Çıktısı) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts: Plus Jakarta Sans -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: {
                        primary: '#4f46e5', // Indigo 600
                        secondary: '#f8fafc', // Slate 50
                        accent: '#06b6d4', // Cyan 500
                        success: '#10b981', // Emerald 500
                        textMain: '#1e293b', // Slate 800
                        textMuted: '#64748b'  // Slate 500
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f1f5f9; color: #1e293b; overflow: hidden; }
        
        /* Modern Sidebar */
        #sidebar { border-right: 1px solid #e2e8f0; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .nav-link { @apply flex items-center gap-3 px-6 py-3.5 rounded-xl text-slate-500 font-semibold text-sm transition-all duration-200 hover:bg-slate-100 hover:text-primary mb-1; }
        .nav-link.active { @apply bg-indigo-50 text-primary border-r-4 border-primary shadow-sm; }

        /* KPI & Content Cards */
        .stat-card { @apply bg-white p-7 rounded-[2rem] border border-white shadow-sm transition-all hover:shadow-lg hover:-translate-y-1; }
        
        /* Table Styles */
        .table-wrapper { @apply bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden; }
        .modern-table { width: 100%; border-collapse: collapse; }
        .modern-table th { @apply bg-slate-50/80 text-slate-400 font-bold py-5 px-8 text-left text-[10px] uppercase tracking-[0.2em] border-b border-slate-100; }
        .modern-table td { @apply py-5 px-8 border-b border-slate-50 text-[14px] text-slate-700 font-medium; }
        .modern-table tr:hover td { background-color: #f8fafc; }
        .modern-table tr:last-child td { border-b: 0; }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        @media (max-width: 1024px) {
            #sidebar.closed { transform: translateX(-100%); }
        }

        /* PDF Çıktısı (Yazdırma) Ayarları */
        @media print {
            body, main, #report-container, .table-wrapper, .overflow-x-auto {
                overflow: visible !important;
                height: auto !important;
                width: auto !important;
                position: static !important;
                background-color: white !important;
            }
            /* Yazdırılırken gizlenecek alanlar */
            #sidebar, header, button, select, #loadingIndicator, #sidebarOverlay, .relative.group {
                display: none !important;
            }
            .table-wrapper {
                box-shadow: none !important;
                border: none !important;
            }
            .modern-table th {
                background-color: #f8fafc !important;
                color: black !important;
            }
        }
    </style>
</head>
<body class="flex h-screen w-full overflow-hidden font-sans">

    <!-- Mobile Overlay -->
    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-30 hidden lg:hidden"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 w-72 bg-white flex flex-col flex-shrink-0 z-40 closed lg:transform-none">
        <div class="h-24 flex items-center px-10 shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-600/20">
                    <i class="fas fa-layer-group text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-slate-900 font-black text-xl tracking-tight uppercase leading-none italic">HEDEF <span class="text-indigo-600 not-italic">AVM</span></h1>
                    <p class="text-slate-400 text-[9px] font-bold uppercase tracking-[0.3em] mt-1.5">Management Pro</p>
                </div>
            </div>
        </div>

        <nav class="flex-1 px-4 py-8 overflow-y-auto custom-scrollbar">
            <div class="px-6 mb-6 text-[10px] font-black text-slate-300 uppercase tracking-[0.4em]">Panel</div>
            <button onclick="setTab('dashboard'); maybeCloseSidebar()" id="btn-dashboard" class="nav-link active w-full">
                <i class="fas fa-chart-pie text-lg"></i> <span>Genel Bakış</span>
            </button>
            <button onclick="setTab('customers'); maybeCloseSidebar()" id="btn-customers" class="nav-link w-full">
                <i class="fas fa-users-viewfinder text-lg"></i> <span>Müşteri Detayları</span>
            </button>
            <button onclick="setTab('followup'); maybeCloseSidebar()" id="btn-followup" class="nav-link w-full">
                <i class="fas fa-phone-arrow-up-right text-lg"></i> <span>Takip Listesi</span>
            </button>
            <button onclick="setTab('unspecified'); maybeCloseSidebar()" id="btn-unspecified" class="nav-link w-full">
                <i class="fas fa-user-xmark text-lg"></i> <span>No Belirtilmeyenler</span>
            </button>
        </nav>

        <div class="p-8 border-t border-slate-100 bg-slate-50/30">
            <div class="flex items-center gap-4 bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-500 border border-indigo-100">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="overflow-hidden">
                    <p class="text-slate-900 text-xs font-bold truncate">Yönetici Paneli</p>
                    <p class="text-slate-400 text-[10px] font-bold">v7.0.0 Pro</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col min-w-0 bg-[#f8fafc] relative">
        
        <!-- HEADER -->
        <header class="h-24 bg-white/70 backdrop-blur-xl border-b border-slate-200/60 px-6 lg:px-12 flex items-center justify-between z-20 shrink-0 sticky top-0">
            <div class="flex items-center gap-6">
                <button onclick="toggleSidebar()" class="lg:hidden w-12 h-12 flex items-center justify-center text-slate-500 bg-slate-100 hover:bg-slate-200 rounded-2xl transition-all">
                    <i class="fas fa-bars-staggered text-xl"></i>
                </button>
                <div class="hidden sm:block w-1.5 h-10 bg-indigo-600 rounded-full"></div>
                <div>
                    <h2 id="tabTitle" class="text-xl lg:text-2xl font-black text-slate-800 tracking-tight">Performans Analizi</h2>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                        <p class="text-slate-400 text-[10px] font-bold uppercase tracking-[0.2em]">Veri Senkronizasyonu Aktif</p>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center gap-3 lg:gap-4">
                <!-- Refresh -->
                <button onclick="fetchData()" class="w-12 h-12 flex items-center justify-center bg-white hover:bg-slate-50 text-indigo-600 rounded-2xl border border-slate-200 transition-all active:scale-90 shadow-sm group" title="Yenile">
                    <i class="fas fa-sync-alt group-active:rotate-180 transition-transform duration-500"></i>
                </button>

                <!-- Aksiyon Filtresi (J Sütunu Değerlerine Göre) -->
                <div id="followupFilterContainer" class="relative group hidden">
                    <select id="followupFilter" onchange="render(currentData)" class="appearance-none bg-amber-50 border border-amber-200 text-amber-700 text-xs font-bold rounded-2xl pl-5 pr-12 py-3.5 focus:ring-4 focus:ring-amber-500/10 focus:border-amber-500 outline-none cursor-pointer transition-all shadow-sm">
                        <option value="Tümü">Tüm Aksiyonlar</option>
                        <option value="müşteri mağazaya gelecek">Müşteri Mağazaya Gelecek</option>
                        <option value="tekrar aranacak">Tekrar Aranacak</option>
                    </select>
                    <i class="fas fa-filter absolute right-5 top-1/2 -translate-y-1/2 text-amber-400 pointer-events-none"></i>
                </div>

                <!-- Şube Seçimi -->
                <div id="branchFilterContainer" class="relative group hidden sm:block">
                    <select id="branchSelector" onchange="render(currentData)" class="appearance-none bg-white border border-slate-200 text-slate-900 text-xs font-bold rounded-2xl pl-5 pr-12 py-3.5 focus:ring-4 focus:ring-indigo-600/10 focus:border-indigo-600 outline-none cursor-pointer transition-all shadow-sm">
                        <option value="Tümü">Tüm Şubeler</option>
                    </select>
                    <i class="fas fa-store absolute right-5 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                </div>

                <!-- Dönem Seçimi -->
                <div class="relative group">
                    <select id="periodSelector" onchange="fetchData()" class="appearance-none bg-slate-900 border border-slate-900 text-white text-xs font-bold rounded-2xl pl-5 pr-12 py-3.5 focus:ring-4 focus:ring-indigo-600/20 outline-none cursor-pointer transition-all shadow-xl">
                        <option value="">Yükleniyor...</option>
                    </select>
                    <i class="fas fa-calendar-days absolute right-5 top-1/2 -translate-y-1/2 text-indigo-400 pointer-events-none"></i>
                </div>
                
                <!-- Excel -->
                <button onclick="exportToExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white h-12 px-8 rounded-2xl text-xs font-black flex items-center justify-center gap-3 transition-all shadow-lg shadow-emerald-600/20 active:scale-95">
                    <i class="fas fa-file-excel text-lg"></i>
                    <span class="hidden md:inline uppercase tracking-widest">Excel'e Aktar</span>
                </button>
            </div>
        </header>

        <!-- DASHBOARD BODY -->
        <div id="report-container" class="flex-1 overflow-y-auto p-6 lg:p-12 custom-scrollbar">
            
            <!-- Dashboard View -->
            <div id="tab-dashboard" class="space-y-10 max-w-7xl mx-auto">
                <!-- KPI Tiles -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 lg:gap-10">
                    <div class="stat-card border-t-8 border-indigo-600">
                        <div class="flex justify-between items-start mb-8">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em]">Brüt Toplam Ciro</span>
                            <div class="w-12 h-12 bg-indigo-50 rounded-2xl flex items-center justify-center text-indigo-600 text-xl"><i class="fas fa-wallet"></i></div>
                        </div>
                        <div id="kpi-revenue" class="text-4xl font-black text-slate-900 tracking-tighter">₺0</div>
                        <div class="mt-6 flex items-center gap-2 text-[10px] font-bold text-emerald-600 bg-emerald-50 w-fit px-4 py-1.5 rounded-full uppercase">
                            <i class="fas fa-check-circle"></i> Onaylı Muhasebe Verisi
                        </div>
                    </div>

                    <div class="stat-card border-t-8 border-emerald-500">
                        <div class="flex justify-between items-start mb-8">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em]">Satış Adedi</span>
                            <div class="w-12 h-12 bg-emerald-50 rounded-2xl flex items-center justify-center text-emerald-600 text-xl"><i class="fas fa-cart-shopping"></i></div>
                        </div>
                        <div id="kpi-sales" class="text-4xl font-black text-slate-900 tracking-tighter">0</div>
                        <div class="mt-6 text-[10px] font-bold text-slate-400 flex items-center gap-2">
                            <i class="far fa-clock text-indigo-300"></i> Son Senk: <span id="lastUpdateTime" class="text-slate-900 font-black">--:--</span>
                        </div>
                    </div>

                    <div class="stat-card border-t-8 border-amber-500">
                        <div class="flex justify-between items-start mb-8">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em]">Ortalama Sepet</span>
                            <div class="w-12 h-12 bg-amber-50 rounded-2xl flex items-center justify-center text-amber-600 text-xl"><i class="fas fa-chart-line"></i></div>
                        </div>
                        <div id="kpi-basket" class="text-4xl font-black text-slate-900 tracking-tighter">₺0</div>
                        <div class="mt-6 w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                            <div class="bg-amber-400 h-full w-2/3 rounded-full shadow-sm"></div>
                        </div>
                    </div>
                </div>

                <!-- Şube Tablo Kartı -->
                <div class="table-wrapper">
                    <div class="px-10 py-7 border-b border-slate-50 bg-slate-50/30 flex items-center justify-between">
                        <h3 class="font-black text-xs text-slate-900 uppercase tracking-[0.2em] flex items-center gap-3">
                            <span class="w-2.5 h-7 bg-indigo-600 rounded-full"></span> Şube Performans Çizelgesi
                        </h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th class="w-24 text-center">ID</th>
                                    <th>Şube Tanımı</th>
                                    <th class="text-right">Satış (Adet)</th>
                                    <th class="text-right px-10">Toplam Tutar</th>
                                </tr>
                            </thead>
                            <tbody id="branch-body">
                                <tr><td colspan="4" class="py-24 text-center text-slate-300 italic font-medium">Veriler çekiliyor...</td></tr>
                            </tbody>
                            <tfoot class="bg-slate-900 text-white font-bold uppercase text-[12px]">
                                <tr>
                                    <td colspan="2" class="py-7 px-10 text-right tracking-[0.3em] opacity-50 uppercase text-[10px]">Genel Dönem Toplamı</td>
                                    <td id="total-sales-val" class="text-right py-7 px-10 text-emerald-400 text-lg">0</td>
                                    <td id="total-revenue-val" class="text-right py-7 px-10 text-indigo-300 text-xl tracking-tight">₺0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Detailed Views Container -->
            <div id="tab-customers" class="hidden space-y-10 max-w-7xl mx-auto">
                <div class="bg-white rounded-[3.5rem] p-12 text-slate-900 shadow-sm border border-slate-200 relative overflow-hidden">
                    <div class="absolute -right-20 -top-20 opacity-5 text-[20rem] rotate-12 text-indigo-600"><i class="fas fa-users-viewfinder"></i></div>
                    <h3 class="text-4xl lg:text-5xl font-black tracking-tighter uppercase italic mb-6">Müşteri Detay Çizelgesi</h3>
                    <div id="customer-period-text" class="bg-slate-50 text-indigo-600 text-[11px] font-black tracking-[0.4em] px-8 py-3 rounded-full border border-slate-200 uppercase w-fit">DÖNEM: ---</div>
                </div>
                <div class="table-wrapper">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th class="w-24 text-center">No</th>
                                <th>MÜŞTERİ KODU (F SÜTUNU)</th>
                                <th class="text-right px-12">İŞLEM TUTARI (TRY)</th>
                            </tr>
                        </thead>
                        <tbody id="customer-body-specified"></tbody>
                        <tfoot class="bg-slate-900 text-white font-bold">
                            <tr>
                                <td colspan="2" class="text-right py-10 px-12 uppercase text-[11px] tracking-widest opacity-40">Liste Toplamı</td>
                                <td id="customer-total-val" class="text-right py-10 px-12 text-indigo-400 text-3xl tracking-tighter font-black">₺0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <div id="tab-followup" class="hidden space-y-10 max-w-7xl mx-auto">
                <div class="bg-white rounded-[3.5rem] p-12 text-slate-900 shadow-sm border-l-[12px] border-amber-500 border-slate-200 relative">
                    <div class="absolute right-12 top-12 opacity-10 text-9xl text-amber-500"><i class="fas fa-headset"></i></div>
                    <h3 class="text-4xl lg:text-5xl font-black tracking-tighter uppercase italic mb-4">Takip & Aksiyon Listesi</h3>
                    <p id="followup-period-text" class="text-amber-600 text-xs font-bold tracking-[0.5em] uppercase italic">Aranacak & Mağazaya Gelecek Müşteriler</p>
                </div>
                <div class="table-wrapper">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th class="w-24 text-center">#</th>
                                <th>MÜŞTERİ AD SOYAD (D)</th>
                                <th>İLETİŞİM HATTI (B)</th>
                                <th class="text-center">AKSİYON DURUMU</th>
                            </tr>
                        </thead>
                        <tbody id="followup-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-unspecified" class="hidden space-y-10 max-w-7xl mx-auto">
                <div class="bg-white rounded-[3.5rem] p-12 text-slate-900 shadow-sm border-l-[12px] border-rose-500 border-slate-200 relative overflow-hidden">
                    <div class="absolute -right-10 -top-10 opacity-5 text-[15rem] rotate-45 text-rose-600"><i class="fas fa-user-ninja"></i></div>
                    <h3 class="text-4xl lg:text-5xl font-black tracking-tighter uppercase italic mb-4">No Belirtilmeyenler</h3>
                    <p id="unspecified-period-text" class="text-rose-600 text-xs font-bold tracking-[0.5em] uppercase">Eksik Veri Kayıt Analizi</p>
                </div>
                <div class="table-wrapper">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th class="w-24 text-center">ID</th>
                                <th>MÜŞTERİ TANIMI (D)</th>
                                <th>DURUM</th>
                                <th class="text-right px-12">TUTAR (TRY)</th>
                            </tr>
                        </thead>
                        <tbody id="unspecified-body"></tbody>
                        <tfoot class="bg-rose-50 text-rose-900 font-bold">
                            <tr>
                                <td colspan="3" class="text-right py-10 px-12 uppercase text-[11px] tracking-widest border-r border-slate-200 opacity-60">Kayıtsız Toplam</td>
                                <td id="unspecified-total-val" class="text-right py-10 px-12 text-rose-600 text-3xl tracking-tighter font-black">₺0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sync Overlay -->
        <div id="loadingIndicator" class="fixed bottom-12 right-12 hidden scale-125 z-50">
            <span class="relative flex h-14 w-14">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-14 w-14 bg-white flex items-center justify-center shadow-2xl border border-slate-100">
                    <i class="fas fa-rotate fa-spin text-indigo-600 text-xl"></i>
                </span>
            </span>
        </div>
    </main>

    <script>
        const APPSCRIPT_URL = "https://script.google.com/macros/s/AKfycbwX2K6gBaSalxAuME90FUJVr086B9D4PKitB4MvqaD5_KNc-rSHI3UWDZIjyftU6quG/exec";
        let currentData = null; 
        let activeTab = 'dashboard';
        
        // Sabit ve spesifik şube sıralaması (Kullanıcının talep ettiği sıralama)
        const PREFERRED_BRANCH_ORDER = [
            "PAŞABAHÇE",
            "KAVACIK",
            "ÇEKMEKÖY",
            "YENİDOĞAN",
            "SULTANBEYLİ",
            "ÇAYIROVA",
            "KÖRFEZ",
            "DERİNCE",
            "İZMİT",
            "GÖLCÜK",
            "İNEGÖL"
        ];

        // Verilen şube isminin sıralamadaki indeksini bulur
        function getBranchSortIndex(branchName) {
            if (!branchName) return 999;
            const upperName = branchName.toLocaleUpperCase('tr-TR');
            for (let i = 0; i < PREFERRED_BRANCH_ORDER.length; i++) {
                if (upperName.includes(PREFERRED_BRANCH_ORDER[i])) {
                    return i;
                }
            }
            return 999; // Listede yoksa en sona at
        }
        
        const safeSetText = (id, text) => { const el = document.getElementById(id); if (el) el.innerText = text; };
        
        function toggleSidebar() { 
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebarOverlay');
            sb.classList.toggle('closed'); 
            ov.classList.toggle('hidden'); 
        }
        
        function maybeCloseSidebar() { if (window.innerWidth < 1024) toggleSidebar(); }

        document.addEventListener('DOMContentLoaded', async () => {
            const sel = document.getElementById('periodSelector');
            const loader = document.getElementById('loadingIndicator');
            loader.classList.remove('hidden');
            try {
                // Tarayıcı önbelleğini kırmak için timestamp (t) eklendi
                const res = await fetch(`${APPSCRIPT_URL}?action=getAvailablePeriods&t=${new Date().getTime()}`);
                const periods = await res.json();
                if (periods && periods.length > 0) {
                    sel.innerHTML = periods.map(p => `<option value="${p}">${p}</option>`).join('');
                    sel.value = periods[0]; 
                    await fetchData();
                }
            } catch (e) { console.error("Dönem yüklenemedi:", e); }
            finally { loader.classList.add('hidden'); }
        });

        async function fetchData() {
            const period = document.getElementById('periodSelector').value;
            if (!period) return;
            const loader = document.getElementById('loadingIndicator');
            loader.classList.remove('hidden');
            try {
                // Cache engelleme (Veri güncellemesinin hemen yansıması için)
                const res = await fetch(`${APPSCRIPT_URL}?action=getDashboardData&sheetName=${encodeURIComponent(period)}&t=${new Date().getTime()}`);
                currentData = await res.json();
                populateBranchFilter(currentData);
                render(currentData);
                const now = new Date(); 
                safeSetText('lastUpdateTime', now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0'));
            } catch (e) { console.error("Veri çekilemedi:", e); }
            finally { loader.classList.add('hidden'); }
        }

        function populateBranchFilter(data) {
            const branchSelector = document.getElementById('branchSelector');
            const currentSelection = branchSelector.value;
            
            // Şubeleri özel sıraya göre diz
            const branches = [...new Set(data.customerList.map(i => i.branch))]
                .sort((a, b) => getBranchSortIndex(a) - getBranchSortIndex(b));
                
            branchSelector.innerHTML = '<option value="Tümü">Tüm Şubeler</option>' + branches.map(b => `<option value="${b}">${b}</option>`).join('');
            if (branches.includes(currentSelection)) branchSelector.value = currentSelection;
        }

        function setTab(tab) {
            activeTab = tab;
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.getElementById(`btn-${tab}`).classList.add('active');
            
            // Filtre görünürlüğü
            const followupFilter = document.getElementById('followupFilterContainer');
            if (tab === 'followup') {
                followupFilter.classList.remove('hidden');
            } else {
                followupFilter.classList.add('hidden');
            }

            const titles = { dashboard: 'Performans Analizi', customers: 'Müşteri Detay Çizelgesi', followup: 'Takip & Aksiyon Listesi', unspecified: 'No Belirtilmeyenler' };
            document.getElementById('tabTitle').innerText = titles[tab];
            if(currentData) render(currentData);
        }

        function render(data) {
            if (!data) return;
            const selectedBranch = document.getElementById('branchSelector').value;
            const selectedAction = document.getElementById('followupFilter').value.toLowerCase();
            
            const fmt = (v) => new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 0 }).format(v);
            const num = (v) => new Intl.NumberFormat('tr-TR').format(v);

            let branchList = data.charts.branch;
            let list = data.customerList;
            if (selectedBranch !== "Tümü") {
                branchList = branchList.filter(b => b.name === selectedBranch);
                list = list.filter(i => i.branch === selectedBranch);
            }

            const salesCount = list.filter(i => i.status.toLowerCase() === 'satışa döndü').length;
            const totalRev = branchList.reduce((a,b) => a+b.revenue, 0);
            
            safeSetText('kpi-revenue', fmt(totalRev));
            safeSetText('kpi-sales', num(salesCount));
            safeSetText('kpi-basket', fmt(salesCount > 0 ? totalRev / salesCount : 0));

            // Özel Sıralamayı Uygula
            branchList.sort((a, b) => getBranchSortIndex(a.name) - getBranchSortIndex(b.name));

            document.getElementById('branch-body').innerHTML = branchList.map((b, i) => `
                <tr>
                    <td class="text-center font-black text-slate-300">#${i+1}</td>
                    <td class="font-extrabold text-slate-900 uppercase tracking-tight">${b.name}</td>
                    <td class="text-right font-bold text-slate-500 tracking-tighter">${num(b.sales)}</td>
                    <td class="text-right font-black text-indigo-600 text-base px-10">${fmt(b.revenue)}</td>
                </tr>
            `).join('') || '<tr><td colspan="4" class="py-24 text-center italic text-slate-400 uppercase tracking-widest text-xs">Kayıt bulunamadı.</td></tr>';
            
            safeSetText('total-sales-val', num(salesCount));
            safeSetText('total-revenue-val', fmt(totalRev));

            safeSetText('customer-period-text', `DÖNEM: ${data.period}`);
            safeSetText('followup-period-text', `DÖNEM: ${data.period}`);
            safeSetText('unspecified-period-text', `DÖNEM: ${data.period}`);

            // Kayıtlı Müşteriler
            const specList = list.filter(i => i.revenue > 0 && i.customerNo && i.customerNo.toLowerCase() !== "belirtilmemiş");
            document.getElementById('customer-body-specified').innerHTML = generateGroupedHtml(specList, fmt);
            safeSetText('customer-total-val', fmt(specList.reduce((a, b) => a + b.revenue, 0)));

            // Takip Listesi (Filtreli)
            let followupList = list.filter(i => {
                const s = i.status.toLowerCase().trim();
                return s === 'tekrar aranacak' || s === 'müşteri mağazaya gelecek';
            });
            
            if (selectedAction !== "tümü") {
                followupList = followupList.filter(i => i.status.toLowerCase().trim() === selectedAction);
            }
            document.getElementById('followup-body').innerHTML = generateFollowupHtml(followupList);

            // No Belirtilmeyenler
            const unspecList = list.filter(i => i.revenue > 0 && (!i.customerNo || i.customerNo.toLowerCase() === "belirtilmemiş"));
            document.getElementById('unspecified-body').innerHTML = generateUnspecifiedHtml(unspecList, fmt);
            safeSetText('unspecified-total-val', fmt(unspecList.reduce((a, b) => a + b.revenue, 0)));
        }

        function generateGroupedHtml(list, fmt) {
            const grouped = list.reduce((acc, curr) => { if(!acc[curr.branch]) acc[curr.branch] = { items: [], total: 0 }; acc[curr.branch].items.push(curr); acc[curr.branch].total += curr.revenue; return acc; }, {});
            return Object.keys(grouped)
                .sort((a, b) => getBranchSortIndex(a) - getBranchSortIndex(b)) // Şubeleri özel sıraya göre diz
                .map(branch => `
                <tr class="bg-slate-50/50"><td colspan="3" class="px-10 py-4 font-black text-indigo-900 text-[11px] uppercase tracking-[0.3em] border-y border-slate-100"><i class="fas fa-location-dot mr-4 text-indigo-500"></i> ${branch}</td></tr>` + 
                grouped[branch].items.map((item, idx) => `<tr><td class="text-center text-slate-300 font-black text-[10px] italic">${idx + 1}</td><td class="font-bold text-slate-700 tracking-tight">${item.customerNo}</td><td class="text-right font-extrabold text-slate-900 px-10">${fmt(item.revenue)}</td></tr>`).join('') + 
                `<tr class="bg-white"><td colspan="2" class="px-10 uppercase text-[9px] font-black tracking-widest opacity-40">Şube Alt Toplamı</td><td class="font-black text-indigo-600 text-lg px-10 text-right">${fmt(grouped[branch].total)}</td></tr>`
            ).join('') || '<tr><td colspan="3" class="py-32 text-center text-slate-300 italic uppercase text-xs">Veri bulunamadı.</td></tr>';
        }

        function generateFollowupHtml(list) {
            const grouped = list.reduce((acc, curr) => { if(!acc[curr.branch]) acc[curr.branch] = { items: [] }; acc[curr.branch].items.push(curr); return acc; }, {});
            return Object.keys(grouped)
                .sort((a, b) => getBranchSortIndex(a) - getBranchSortIndex(b)) // Şubeleri özel sıraya göre diz
                .map(branch => `
                <tr class="bg-slate-50/50"><td colspan="4" class="px-10 py-4 font-black text-indigo-900 text-[11px] uppercase tracking-[0.3em] border-y border-slate-100"><i class="fas fa-headset mr-4 text-indigo-500"></i> ${branch}</td></tr>` + 
                grouped[branch].items.map((item, idx) => {
                    const status = item.status.toLowerCase().trim();
                    const isAranacak = status === 'tekrar aranacak';
                    const badgeClass = isAranacak ? 'bg-amber-100 text-amber-700 border border-amber-200' : 'bg-indigo-100 text-indigo-700 border border-indigo-200';
                    const label = isAranacak ? 'Tekrar Aranacak' : 'Mağazaya Gelecek';
                    
                    return `
                    <tr>
                        <td class="text-center text-slate-300 font-black text-[10px] italic">${idx + 1}</td>
                        <td class="font-extrabold uppercase text-slate-900 tracking-tighter">${item.customerName || "---"}</td>
                        <td class="font-mono font-black text-indigo-600">${item.phone || "---"}</td>
                        <td class="text-center">
                            <span class="px-5 py-2 rounded-2xl text-[10px] font-black uppercase tracking-widest ${badgeClass}">
                                ${label}
                            </span>
                        </td>
                    </tr>`;
                }).join('')
            ).join('') || '<tr><td colspan="4" class="py-32 text-center text-slate-300 italic uppercase text-xs tracking-widest">Takip listesi boş.</td></tr>';
        }

        function generateUnspecifiedHtml(list, fmt) {
            const grouped = list.reduce((acc, curr) => { if(!acc[curr.branch]) acc[curr.branch] = { items: [], total: 0 }; acc[curr.branch].items.push(curr); acc[curr.branch].total += curr.revenue; return acc; }, {});
            return Object.keys(grouped)
                .sort((a, b) => getBranchSortIndex(a) - getBranchSortIndex(b)) // Şubeleri özel sıraya göre diz
                .map(branch => `
                <tr class="bg-rose-50/50"><td colspan="4" class="px-10 py-4 font-black text-rose-900 text-[11px] uppercase tracking-[0.3em] border-y border-rose-100"><i class="fas fa-circle-exclamation mr-4 text-rose-500"></i> ${branch}</td></tr>` + 
                grouped[branch].items.map((item, idx) => `<tr><td class="text-center text-rose-200 font-black text-[10px] italic">${idx + 1}</td><td class="font-black uppercase text-slate-900 tracking-tighter">${item.customerName || "---"}</td><td class="text-rose-500 font-bold text-[10px] italic uppercase opacity-60">Numara Eksik</td><td class="text-right font-black text-rose-800 px-10">${fmt(item.revenue)}</td></tr>`).join('') + 
                `<tr class="bg-white"><td colspan="3" class="text-rose-900 font-black px-10 text-[9px] tracking-[0.3em] uppercase">Şube Toplamı</td><td class="font-black text-rose-700 text-lg px-10 text-right">${fmt(grouped[branch].total)}</td></tr>`
            ).join('') || '<tr><td colspan="4" class="py-32 text-center text-slate-300 italic uppercase text-xs tracking-widest">Tüm kayıtlar eksiksiz.</td></tr>';
        }

        function exportToExcel() {
            if (!currentData) return;
            const period = document.getElementById('periodSelector').value;
            const selectedBranch = document.getElementById('branchSelector').value;
            const selectedAction = document.getElementById('followupFilter').value.toLowerCase();

            const wb = XLSX.utils.book_new(); const currencyFormat = '#,##0"₺"';
            let wsData = []; let fileName = `Hedef_AVM_${activeTab}_${selectedBranch}_${period}.xlsx`.replace(/ /g, '_');
            const branchText = selectedBranch === "Tümü" ? "TÜM ŞUBELER" : selectedBranch.toUpperCase();

            wsData.push([branchText + " - " + period.toUpperCase() + " RAPORU"]);
            wsData.push(["GENEL TÜM ŞUBELERİN TOPLAM TUTARI:", currentData.kpis.totalRevenue]);
            wsData.push([]);

            if (activeTab === 'dashboard') {
                wsData.push(["SIRA", "ŞUBE ADI", "SATIŞA DÖNEN (ADET)", "TOPLAM TUTAR (TL)"]);
                let list = currentData.charts.branch;
                if (selectedBranch !== "Tümü") list = list.filter(b => b.name === selectedBranch);
                // Özel Sıralamayı Uygula
                list.sort((a, b) => getBranchSortIndex(a.name) - getBranchSortIndex(b.name));
                list.forEach((b, i) => wsData.push([i+1, b.name.toUpperCase(), b.sales, b.revenue]));
            } else if (activeTab === 'customers') {
                wsData.push(["ŞUBE", "MÜŞTERİ NO", "İŞLEM TUTARI (TL)"]);
                let list = currentData.customerList.filter(i => i.revenue > 0 && i.customerNo && i.customerNo.toLowerCase() !== "belirtilmemiş");
                if (selectedBranch !== "Tümü") list = list.filter(i => i.branch === selectedBranch);
                list.sort((a, b) => getBranchSortIndex(a.branch) - getBranchSortIndex(b.branch));
                list.forEach(i => wsData.push([i.branch.toUpperCase(), i.customerNo, i.revenue]));
            } else if (activeTab === 'followup') {
                wsData.push(["ŞUBE", "MÜŞTERİ AD SOYAD", "TELEFON NO", "AKSİYON DURUMU"]);
                let list = currentData.customerList.filter(i => {
                    const s = i.status.toLowerCase().trim();
                    return s === 'tekrar aranacak' || s === 'müşteri mağazaya gelecek';
                });
                if (selectedBranch !== "Tümü") list = list.filter(i => i.branch === selectedBranch);
                if (selectedAction !== "tümü") list = list.filter(i => i.status.toLowerCase().trim() === selectedAction);
                list.sort((a, b) => getBranchSortIndex(a.branch) - getBranchSortIndex(b.branch));
                list.forEach(i => wsData.push([i.branch.toUpperCase(), i.customerName.toUpperCase(), i.phone, i.status.toUpperCase()]));
            } else {
                wsData.push(["ŞUBE", "MÜŞTERİ AD SOYAD", "DURUM", "İŞLEM TUTARI (TL)"]);
                let list = currentData.customerList.filter(i => i.revenue > 0 && (!i.customerNo || i.customerNo.toLowerCase() === "belirtilmemiş"));
                if (selectedBranch !== "Tümü") list = list.filter(i => i.branch === selectedBranch);
                list.sort((a, b) => getBranchSortIndex(a.branch) - getBranchSortIndex(b.branch));
                list.forEach(i => wsData.push([i.branch.toUpperCase(), i.customerName.toUpperCase(), "NO BELİRTİLMEMİŞ", i.revenue]));
            }

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const range = XLSX.utils.decode_range(ws['!ref']);
            const moneyIdx = activeTab === 'unspecified' ? 3 : (activeTab === 'customers' ? 2 : 3);
            
            const totalCellRef = XLSX.utils.encode_cell({ r: 1, c: 1 });
            if (ws[totalCellRef]) ws[totalCellRef].z = currencyFormat;

            if (activeTab !== 'followup') {
                for (let R = 3; R <= range.e.r; ++R) {
                    const cell = ws[XLSX.utils.encode_cell({ r: R, c: moneyIdx })];
                    if (cell && typeof cell.v === 'number') cell.z = currencyFormat;
                }
            }
            ws['!cols'] = [{wch: 35}, {wch: 35}, {wch: 25}, {wch: 25}];
            XLSX.utils.book_append_sheet(wb, ws, "Hedef AVM Raporu");
            XLSX.writeFile(wb, fileName);
        }
    </script>
</body>
</html>
