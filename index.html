<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Mağaza Performans Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f3f6f9; }
    .card { background: white; border-radius: 20px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); border: 1px solid white; }
    .input-style { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 10px; transition: all 0.2s; font-size: 14px; }
    .input-style:focus { border-color: #10b981; ring: 2px; ring-color: #10b981; outline: none; background: white; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    th { background-color: #f8fafc; color: #64748b; font-weight: 700; text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em; padding: 16px; border-bottom: 1px solid #e2e8f0; }
    td { padding: 16px; border-bottom: 1px solid #f1f5f9; font-size: 14px; color: #1e293b; }
    tr:last-child td { border-bottom: none; }
    .trend-up { color: #10b981; font-weight: 700; }
    .trend-down { color: #f43f5e; font-weight: 700; }
  </style>
</head>
<body class="antialiased text-slate-800">

  <div class="max-w-7xl mx-auto px-4 py-8 space-y-6">
    
    <!-- Başlık ve Kontroller -->
    <header class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-6 rounded-[1.5rem] shadow-sm border border-white">
      <div>
        <h1 class="text-2xl font-extrabold text-slate-800 tracking-tight">Performans Karşılaştırma Paneli</h1>
        <p id="dateRangeText" class="text-slate-400 text-sm font-medium mt-1 italic italic">Veriler yükleniyor...</p>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="refreshDashboard()" class="p-2.5 bg-slate-100 hover:bg-slate-200 rounded-xl transition-all" title="Verileri Yenile">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
        </button>
        <button onclick="downloadPDF()" id="pdfBtn" class="bg-emerald-600 text-white px-5 py-2.5 rounded-xl font-bold hover:bg-emerald-700 shadow-lg shadow-emerald-100 transition-all flex items-center gap-2">
          PDF Raporu
        </button>
      </div>
    </header>

    <!-- Filtreleme ve Veri Girişi Alanı -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="card p-6 flex flex-col gap-4">
        <div class="flex justify-between items-center">
          <h2 class="text-sm font-bold text-emerald-800 uppercase tracking-widest">Tarih Aralığı Seç</h2>
          <button onclick="clearFilter()" class="text-[10px] font-bold text-slate-400 hover:text-emerald-600 transition-colors uppercase">Sıfırla</button>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div class="space-y-1">
            <span class="text-[10px] font-bold text-slate-400 ml-1 uppercase">Başlangıç</span>
            <input type="date" id="filterStart" class="w-full input-style" onchange="applyFilter()">
          </div>
          <div class="space-y-1">
            <span class="text-[10px] font-bold text-slate-400 ml-1 uppercase">Bitiş</span>
            <input type="date" id="filterEnd" class="w-full input-style" onchange="applyFilter()">
          </div>
        </div>
      </section>

      <section class="lg:col-span-2 card p-6">
        <h2 class="text-sm font-bold text-emerald-800 uppercase tracking-widest mb-4">Hızlı Veri Girişi</h2>
        <form id="dataForm" class="flex flex-wrap items-end gap-3">
          <input type="date" id="tarih" required class="input-style flex-1 min-w-[120px]">
          <select id="magaza" class="input-style flex-1 min-w-[150px]">
            <option>Paşabahçe</option><option>Kavacık</option><option>Çekmeköy</option>
            <option>Yenidoğan</option><option>Sultanbeyli</option><option>Çayırova</option>
            <option>Körfez</option><option>Derince</option><option>İzmit</option>
            <option>Gölcük</option><option>İnegöl</option>
          </select>
          <input type="number" id="yorum" placeholder="Yorum" required class="input-style w-24">
          <input type="number" id="puan" step="0.1" min="1" max="5" placeholder="Puan" required class="input-style w-20">
          <button type="submit" id="submitBtn" class="bg-slate-800 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-slate-900 transition-all">Kaydet</button>
        </form>
      </section>
    </div>

    <!-- Ana Performans Tablosu -->
    <section class="card overflow-hidden shadow-sm">
      <div class="p-6 border-b border-slate-50 flex justify-between items-center bg-slate-50/30">
        <h2 class="text-lg font-bold text-slate-800">Şube Performans Karşılaştırma Tablosu</h2>
        <div id="loader" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-emerald-600"></div>
      </div>
      <div class="overflow-x-auto">
        <table>
          <thead>
            <tr>
              <th class="text-left">Mağaza Adı</th>
              <th class="text-center">Önceki Yorum</th>
              <th class="text-center">Önceki Puan</th>
              <th class="text-center">Yeni Yorum</th>
              <th class="text-center">Yeni Puan</th>
              <th class="text-center">Yorum Farkı</th>
              <th class="text-center">Puan Farkı</th>
              <th class="text-right">Değişim %</th>
            </tr>
          </thead>
          <tbody id="dataTable">
            <!-- Veriler JS ile buraya gelecek -->
          </tbody>
        </table>
      </div>
    </section>

  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz29zzy7qchsQTHaV6DYR10W6xoGgRWyy5OSlqZAlQ_I-I-fAX96N6ExR72St0fXUgcOA/exec";
    let fullData = []; 

    window.onload = () => {
      const today = new Date();
      document.getElementById('tarih').valueAsDate = today;
      clearFilter();
      refreshDashboard();
    };

    function clearFilter() {
      const today = new Date();
      const lastMonth = new Date();
      lastMonth.setDate(today.getDate() - 30);
      document.getElementById('filterStart').valueAsDate = lastMonth;
      document.getElementById('filterEnd').valueAsDate = today;
      if (fullData.length > 0) applyFilter();
    }

    async function apiCall(action, params = {}) {
      if (typeof google !== 'undefined' && google.script && google.script.run) {
        return new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)[action](params);
        });
      }
      const url = new URL(API_URL);
      url.searchParams.append('action', action);
      if (action === 'submitData' || action === 'generatePDFReport') {
        Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
      }
      try {
        const response = await fetch(url.toString());
        return await response.json();
      } catch (error) {
        console.error("API Hatası:", error);
        throw error;
      }
    }

    async function refreshDashboard() {
      document.getElementById('loader').classList.remove('hidden');
      try {
        fullData = await apiCall('getDashboardData');
        applyFilter(); 
      } catch (e) {
        console.error("Dashboard yüklenemedi");
      } finally {
        document.getElementById('loader').classList.add('hidden');
      }
    }

    function applyFilter() {
      const startInput = document.getElementById('filterStart').value;
      const endInput = document.getElementById('filterEnd').value;
      
      const start = new Date(startInput);
      const end = new Date(endInput);
      end.setHours(23, 59, 59);

      document.getElementById('dateRangeText').innerText = `${start.toLocaleDateString('tr-TR')} - ${end.toLocaleDateString('tr-TR')} tarihleri arasındaki değişim`;

      const filtered = fullData.filter(row => {
        const rowDate = new Date(row[0]);
        return rowDate >= start && rowDate <= end;
      });

      updateUI(filtered);
    }

    function updateUI(data) {
      const tableBody = document.getElementById('dataTable');
      tableBody.innerHTML = '';
      
      if (!data || data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="8" class="p-20 text-center text-slate-400 font-medium">Seçili tarihler arasında veri bulunamadı.</td></tr>';
        return;
      }

      const stores = {};
      data.forEach(row => {
        const date = new Date(row[0]);
        const name = row[1];
        const comments = parseInt(row[2]) || 0;
        let score = parseFloat(row[3]);
        if (isNaN(score) || score > 10) score = 0;

        if (!stores[name]) {
          stores[name] = { first: { date, comments, score }, last: { date, comments, score } };
        } else {
          if (date < stores[name].first.date) stores[name].first = { date, comments, score };
          if (date > stores[name].last.date) stores[name].last = { date, comments, score };
        }
      });

      Object.keys(stores).sort().forEach(name => {
        const s = stores[name];
        const cDiff = s.last.comments - s.first.comments;
        const sDiff = s.last.score - s.first.score;
        const percentChange = s.first.comments > 0 ? ((cDiff / s.first.comments) * 100).toFixed(1) : "0.0";

        const tr = document.createElement('tr');
        tr.className = "hover:bg-slate-50/50 transition-colors";
        
        tr.innerHTML = `
          <td class="font-bold text-slate-800">${name}</td>
          <td class="text-center text-slate-500">${s.first.comments}</td>
          <td class="text-center text-slate-500 font-medium">${s.first.score.toFixed(1)} ★</td>
          <td class="text-center font-bold">${s.last.comments}</td>
          <td class="text-center font-bold text-emerald-700">${s.last.score.toFixed(1)} ★</td>
          <td class="text-center font-bold ${cDiff >= 0 ? 'text-emerald-600' : 'text-rose-600'}">
            ${cDiff > 0 ? '+' : ''}${cDiff}
          </td>
          <td class="text-center font-bold ${sDiff >= 0 ? 'text-emerald-600' : 'text-rose-600'}">
            ${sDiff > 0 ? '+' : ''}${sDiff.toFixed(1)}
          </td>
          <td class="text-right">
            <span class="px-3 py-1 rounded-lg text-xs font-bold ${cDiff >= 0 ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'}">
              % ${percentChange}
            </span>
          </td>
        `;
        tableBody.appendChild(tr);
      });
    }

    document.getElementById('dataForm').onsubmit = async (e) => {
      e.preventDefault();
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.innerText = "...";

      const formData = {
        tarih: document.getElementById('tarih').value,
        magaza: document.getElementById('magaza').value,
        yorum: document.getElementById('yorum').value,
        puan: document.getElementById('puan').value
      };

      try {
        await apiCall('submitData', formData);
        document.getElementById('dataForm').reset();
        document.getElementById('tarih').valueAsDate = new Date();
        refreshDashboard();
      } catch (err) {
        alert("Kayıt sırasında hata oluştu!");
      } finally {
        btn.disabled = false;
        btn.innerText = "Kaydet";
      }
    };

    async function downloadPDF() {
      const btn = document.getElementById('pdfBtn');
      btn.innerText = "Hazırlanıyor...";
      btn.disabled = true;

      const params = {
        start: document.getElementById('filterStart').value,
        end: document.getElementById('filterEnd').value
      };

      try {
        const base64 = await apiCall('generatePDFReport', params);
        if (!base64) { alert("Veri bulunamadı."); return; }
        const link = document.createElement('a');
        link.href = 'data:application/pdf;base64,' + base64;
        link.download = 'Magaza_Performans_Analizi.pdf';
        link.click();
      } catch (err) {
        alert("PDF oluşturma hatası!");
      } finally {
        btn.innerText = "PDF Raporu";
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
